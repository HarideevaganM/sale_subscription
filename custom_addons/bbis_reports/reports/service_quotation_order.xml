<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Report Setup -->
    <report id="bbis_reports_service_quotation"
        model="sale.order"
        string="Service Quotation / Order (BBIS)"
        report_type="qweb-pdf"
        file="bbis_reports.service_quotation_order"
        name="bbis_reports.service_quotation_order"
        paperformat="bbis_reports.bbis_sale_order_paper_format"
        print_report_name="(object.state in ('draft', 'sent') and 'Quotation - %s' % (object.quote_name)) or 'Order - %s' % (object.quote_name)"
    /><!-- End: End Report Setup -->

    <!-- Report Template -->
    <template id="service_quotation_order_document">
        <div class="header">
            <div class="text-center">
                <img class="bbis-company-logo" style="height:130px; width:auto;" src="/bbis_reports/static/src/img/blackbox-logo.svg" alt="Logo"/>
            </div>
        </div>
        <div class="article o_report_layout_standard">
            <div class="page">
                <h1 class="text-center" style="margin:10px 0 40px 0; font-size:22pt"><strong>Service Quotation</strong></h1>

                <!-- Sale Quotation Order Header -->
                <div class="bbis-sale-quote-order-header clearfix" >
                    <table>
                        <tr>
                            <th>Customer</th><td class="colon-space">:</td>
                            <td>
                                <span t-field="doc.partner_id" t-options='{"widget": "contact", "fields": ["name"], "no_marker": True}' />
                            </td>
                        </tr>
                        <tr>
                            <th style="vertical-align: top;">Address</th><td class="colon-space">:</td>
                            <td>
                                <t t-if="doc.partner_id.street"><span t-esc="doc.partner_id.street"/><br/></t>

                                <t t-if="doc.partner_id.street2"><span t-esc="doc.partner_id.street2"/>,</t>
                                <t t-if="doc.partner_id.city and doc.partner_id.city.strip()"><span t-esc="doc.partner_id.city"/>,</t>
                                <t t-if="doc.partner_id.state_id">, <span t-esc="doc.partner_id.state_id.name"/>,</t>
                                <t t-if="doc.partner_id.zip and doc.partner_id.zip.strip()"><span t-esc="doc.partner_id.zip"/>,</t>
                                <span t-if="doc.partner_id.country_id" t-esc="doc.partner_id.country_id.name"/>
                            </td>
                        </tr>
                        <tr>
                            <th class="nowrap">Tel No.</th><td class="colon-space">:</td>
                            <td>
                                <t t-if="doc.partner_id.phone"><span t-esc="doc.partner_id.phone"/></t>
                            </td>
                        </tr>
                        <tr>
                            <th class="nowrap">Mobile No.</th><td class="colon-space">:</td>
                            <td>
                                <t t-if="doc.partner_id.mobile"><span t-esc="doc.partner_id.mobile"/></t>
                            </td>
                        </tr>
                        <tr>
                            <th>Email</th><td class="colon-space">:</td>
                            <td>
                                <span t-field="doc.partner_id" t-options='{"widget": "contact", "fields": ["email"], "no_marker": True}' />
                            </td>
                        </tr>
                        <tr>
                            <th>Attention</th><td class="colon-space">:</td>
                            <td>
                                <span t-if="doc.res_contact_id" t-esc="doc.res_contact_id.name"/>
                            </td>
                        </tr>
                    </table>
                    <table>
                        <tr>
                            <td>
                                <table style="float:right">
                                    <tr>
                                        <th class="text-right">Quote Ref</th><td class="colon-space">:</td>
                                        <td><span t-field="doc.quote_name"/></td>
                                    </tr>
                                    <tr>
                                        <th class="text-right">Date</th><td class="colon-space">:</td>
                                        <td><span t-field="doc.date_order" t-field-options='{"format": "dd/MM/yyyy"}'/></td>
                                    </tr>
                                    <tr>
                                        <th class="text-right">Tel No.</th><td class="colon-space">:</td>
                                        <td><span t-esc="doc.company_id.phone"/></td>
                                    </tr>
                                    <tr>
                                        <th class="text-right">Fax No.</th><td class="colon-space">:</td>
                                        <td><span t-esc="doc.company_id.fax_new"/></td>
                                    </tr>
                                    <tr>
                                        <th class="text-right">Sales Name</th><td class="colon-space">:</td>
                                        <td><span t-if="doc.user_id" t-esc="doc.user_id.name"/></td>
                                    </tr>
                                    <tr>
                                        <th class="text-right nowrap">Service Type</th><td class="colon-space">:</td>
                                        <td><span t-esc="doc.support_id.subject"/></td>
                                    </tr>
                                    <tr>
                                        <th class="text-right">Revision</th><td class="colon-space">:</td>
                                        <td><span t-esc="doc.revisions"/></td>
                                    </tr>
                                </table>
                            </td>
                        </tr>

                    </table>
                </div><!-- End: Sale Quotation Order Header -->

                <!-- Service Quotation Order Lines Table -->
                <table class="bbis-sale-quote-order-items-table" id="bbisSaleOrderLinesTableHeight">
                    <tr>
                        <th class="text-center bbis_so_th_prod_sn">S/N</th>
                        <th class="text-center bbis_so_th_prod_code">Codes</th>
                        <th class="text-center bbis_so_th_prod_desc">Description</th>
                        <th class="text-center bbis_so_th_prod_qty">Quantity</th>
                        <th class="text-center bbis_so_th_prod_price">Unit Price</th>
                        <t t-if="single_total_discount">
                            <th class="text-center bbis_so_th_prod_discount">Discount</th>
                        </t>
                        <th class="text-right bbis_so_th_prod_amount">
                            <span groups="sale.group_show_price_subtotal">Amount</span>
                            <span groups="sale.group_show_price_total">Amount</span>
                        </th>
                    </tr>
                    <tbody>

                        <t t-set="price_subtotal" t-value="0.0" />
                        <t t-set="discount_total" t-value="0.0" />

                        <tr t-foreach="doc.order_line" t-as="l">

                            <!-- Do not include line with zero quantity -->
                            <t t-if="l.product_uom_qty >= 1">
                                <td class="text-center"><span t-esc="l_index + 1" /></td>
                                <td class="text-center">
                                    <span t-if="l.product_id.default_code" t-field="l.product_id.default_code"/>
                                    <span t-else="">N/A</span>
                                </td>
                                <td><span t-esc="l.name[l.name.find('] ')+1:]"/></td>
                                <td class="text-center">
                                    <span t-field="l.product_uom_qty" t-options='{"widget": "float", "precision": 0}'/>
                                </td>
                                <td class="text-right">
                                    <span t-field="l.price_unit" t-options='{"widget": "float", "precision": 2}'/>
                                </td>
                                <t t-if="single_total_discount">
                                    <td class="text-right">
                                        <span t-field="l.discount_amount" t-options='{"widget": "float", "precision": 2}'/>
                                    </td>
                                </t>
                                <td class="text-right">
                                    <span t-field="l.price_subtotal" t-options='{"widget": "float", "precision": 2}'/>
                                </td>

                                <t t-set="price_subtotal" t-value="price_subtotal + l.price_unit" />
                                <t t-set="discount_total" t-value="discount_total + l.discount_amount" />
                            </t>
                        </tr>

                        <t t-if="discount_total">
                            <tr>
                                <td colspan="3" style="border-bottom:none"> </td>
                                <td><strong>Discount</strong></td>
                                <td class="text-right"> </td>
                                <td class="text-right"><span t-esc="discount_total" t-options='{"widget": "float", "precision": 2}'/></td>
                                <td> </td>
                            </tr>
                        </t>

                        <tr>
                            <td rowspan="3" colspan="3" style="border-top:none"> </td>
                            <td><strong>Sub Total</strong></td>
                            <td> </td>
                            <t t-if="single_total_discount"><td> </td></t>
                            <td class="text-right"><span t-field="doc.amount_untaxed" t-options='{"widget": "float", "precision": 2}'/></td>
                        </tr>
                        <t t-set="price_vat" t-value="get_price_vat(doc.order_line)" />
                        <t t-set="price_amount_total" t-value="price_vat + price_subtotal" />
                        <tr>
                            <td><strong>VAT (5%)</strong></td>

                            <td> </td>
                            <t t-if="single_total_discount"><td> </td></t>
                            <td class="text-right">
                                <span t-field="doc.amount_tax" t-options='{"widget": "float", "precision": 2}'/>
                            </td>
                        </tr>
                        <tr>
                            <td class="bbis_so_th_prod_qty"><strong>Total Incl. VAT</strong></td>
                            <td> </td>
                            <t t-if="single_total_discount"><td> </td></t>
                            <td class="text-right">
                                <strong>
                                    <span t-field="doc.amount_total" t-options='{"widget": "float", "precision": 2}'/>
                                </strong>
                            </td>
                        </tr>
                    </tbody>
                    <tr>
                        <td colspan="7" class="bbis-sale-quote-order-table-title text-center">
                            Total Amount in Words: <span t-esc="doc.currency_id.name"/> <span t-esc="convert_num_to_word(doc, doc.amount_total)"/>
                        </td>
                    </tr>
                </table>

                <!-- Terms and Conditions -->
                <div t-if="doc.terms_pb" style="page-break-before: always;"/>
                <div class="bbis-sale-quote-order-table-title-div">
                    Terms and Conditions
                </div>

                <table class="bbis-sale-order-terms-table">
                    <tr t-if="doc.report_warranty_line">
                        <th>Warranty:</th>
                        <td><span t-esc="', '.join([ lt.name or '' for lt in doc.report_warranty_line ])"/></td>
                    </tr>
                    <tr t-if="doc.contract_period_report_line">
                        <th>Contract Period:</th>
                        <td><span t-esc="', '.join([ lt.name or '' for lt in doc.contract_period_report_line ])"/></td>
                    </tr>
                    <tr t-if="doc.report_payment_terms_line">
                        <th>Payment Terms:</th>
                        <td><span t-esc="', '.join([ lt.name or '' for lt in doc.report_payment_terms_line ])"/></td>
                    </tr>
                    <tr t-if="doc.delivery_installation_schedule">
                        <th>Delivery Schedule:</th>
                        <td><span t-esc="', '.join([ lt.name or '' for lt in doc.delivery_installation_schedule ])"/></td>
                    </tr>

                    <tr t-if="doc.report_service_support">
                        <th>Communication Charges:</th>
                        <td><span t-esc="', '.join([ lt.name or '' for lt in doc.report_service_support ])"/></td>
                    </tr>
                    <tr t-if="doc.hosting_maintenance">
                        <th>Hosting &amp;amp; Maintenance Fees:</th>
                        <td><span t-esc="doc.hosting_maintenance"/></td>
                    </tr>
                    <tr t-if="doc.report_validity">
                        <th>Validity:</th>
                        <td><span t-esc="', '.join([ lt.name or '' for lt in doc.report_validity])"/></td>
                    </tr>

                    <tr t-if="doc.documentd_required">
                        <th>Required Documents:</th>
                        <td><span t-esc="doc.documentd_required"/></td>
                    </tr>
                    <tr t-if="doc.training">
                        <th>Training:</th>
                        <td><span t-esc="doc.training"/></td>
                    </tr>
                    <tr t-if="doc.device_ownership">
                        <th>Device Ownership:</th>
                        <td><span t-esc="doc.device_ownership"/></td>
                    </tr>
                    <tr t-if="doc.term_note">
                        <th>Note:</th>
                        <td><span t-esc="doc.term_note"/></td>
                    </tr>
                    <tr t-if="doc.minimum_billing_quantity">
                        <th>Minimum Billing Quantity:</th>
                        <td><span t-esc="doc.minimum_billing_quantity"/></td>
                    </tr>
                    <tr t-if="doc.tc_vehicle_details">
                        <th>Vehicle Details:</th>
                        <td><span t-esc="doc.tc_vehicle_details"/></td>
                    </tr>
                </table><!-- End: Terms and Conditions -->

            </div>
        </div>
        <div class="footer">
            <t t-call="bbis_reports.bbis_custom_sale_footer"/>
        </div>
    </template>

    <template id="service_quotation_order">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="bbis_reports.service_quotation_order_document" />
            </t>
        </t>
    </template><!-- End: Report Template -->
</odoo>